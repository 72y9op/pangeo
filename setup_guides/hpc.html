<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Getting Started with Pangeo on HPC &#8212; Pangeo 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pangeo-style.css" type="text/css" />
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Getting Started with Pangeo on the Cloud" href="cloud.html" />
    <link rel="prev" title="Pangeo Setup Guides" href="index.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html"><span><img src="../_static/small_e_reversed_24px.png"></span>
          Pangeo</a>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="http://pangeo-data.github.io">Blog</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Pangeo</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../about.html#motivation">Motivation</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#mission-statement">Mission Statement</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#vision">Vision</a></li>
<li class="toctree-l2"><a class="reference internal" href="../about.html#get-involved">Get Involved</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">Frequently Asked Questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Guide for Scientists</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#learn-about-the-open-source-ecosystem">Learn About the Open Source Ecosystem</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#learn-about-pangeo-software">Learn About Pangeo Software</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#explore-the-use-cases">Explore the Use Cases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#try-out-a-pangeo-deployment">Try Out a Pangeo Deployment</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#give-feedback">Give Feedback</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#contribute-a-use-case">Contribute a Use Case</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#contribute-data">Contribute Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#become-an-open-source-contributor">Become an Open Source Contributor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html#develop-new-software">Develop New Software</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../packages.html">Packages</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#pangeo-core-packages">Pangeo Core Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#pangeo-affiliated-packages">Pangeo Affiliated Packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../packages.html#guidelines-for-new-packages">Guidelines for New Packages</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../use_cases/index.html">Geoscience Use Cases</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/ocean_cm2.6_eddy_statistics.html">Use Case: CM2.6 Eddy Statistics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../use_cases/newmann_ensemble_meteorology.html">Analysis of Gridded Ensemble Precipitation and Temperature Estimates over the Contiguous United States</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../architecture.html">Technical Architecture</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Pangeo Setup Guides</a><ul class="current">
<li class="toctree-l2 current"><a class="reference internal" href="index.html#setting-up-pangeo-on-hpc-systems">Setting up Pangeo on HPC Systems</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-pangeo-on-cloud-systems">Setting up Pangeo on Cloud Systems</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../deployments.html">Deployments</a></li>
<li class="toctree-l1"><a class="reference internal" href="../collaborators.html">Collaborators</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#funding-agencies">Funding Agencies</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#institutions">Institutions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../collaborators.html#people">People</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Getting Started with Pangeo on HPC</a><ul>
<li><a class="reference internal" href="#installing-a-software-environment">Installing a software environment</a></li>
<li><a class="reference internal" href="#configure-jupyter">Configure Jupyter</a></li>
<li><a class="reference internal" href="#deploy-option-1-jupyter-dask-jobqueue">Deploy Option 1: Jupyter + dask-jobqueue</a><ul>
<li><a class="reference internal" href="#start-a-jupyter-notebook-server">Start a Jupyter Notebook Server</a></li>
<li><a class="reference internal" href="#launch-dask-with-dask-jobqueue">Launch Dask with dask-jobqueue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploy-option-2-jupyter-dask-mpi">Deploy Option 2: Jupyter + dask-mpi</a><ul>
<li><a class="reference internal" href="#launch-and-connect-to-jupyter">Launch and connect to Jupyter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
            
            
            
          </ul>

          
            
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="#">Getting Started with Pangeo on HPC</a><ul>
<li><a class="reference internal" href="#installing-a-software-environment">Installing a software environment</a></li>
<li><a class="reference internal" href="#configure-jupyter">Configure Jupyter</a></li>
<li><a class="reference internal" href="#deploy-option-1-jupyter-dask-jobqueue">Deploy Option 1: Jupyter + dask-jobqueue</a><ul>
<li><a class="reference internal" href="#start-a-jupyter-notebook-server">Start a Jupyter Notebook Server</a></li>
<li><a class="reference internal" href="#launch-dask-with-dask-jobqueue">Launch Dask with dask-jobqueue</a></li>
</ul>
</li>
<li><a class="reference internal" href="#deploy-option-2-jupyter-dask-mpi">Deploy Option 2: Jupyter + dask-mpi</a><ul>
<li><a class="reference internal" href="#launch-and-connect-to-jupyter">Launch and connect to Jupyter</a></li>
</ul>
</li>
<li><a class="reference internal" href="#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9 content ">
      
  <div class="section" id="getting-started-with-pangeo-on-hpc">
<span id="hpc"></span><h1>Getting Started with Pangeo on HPC<a class="headerlink" href="#getting-started-with-pangeo-on-hpc" title="Permalink to this headline">¶</a></h1>
<p>This tutorial covers how to set up an environment to run Pangeo on High
Performance Computing (HPC) systems. In particular it covers the following:</p>
<ol class="arabic simple">
<li>Install <a class="reference external" href="https://conda.io/docs/">conda</a> and creating an environment</li>
<li>Configure <a class="reference external" href="https://jupyter.org/">Jupyter</a></li>
<li>Launch <a class="reference external" href="https://dask.pydata.org/">Dask</a> with a job scheduler</li>
<li>Launch a <a class="reference external" href="https://jupyter.org/">Jupyter</a> server for your job</li>
<li>Connect to <a class="reference external" href="https://jupyter.org/">Jupyter</a> and the <a class="reference external" href="https://dask.pydata.org/">Dask</a> dashboard from your personal computer</li>
</ol>
<p>Although the examples on this page were developed using NCAR’s <a class="reference external" href="https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne">Cheyenne</a> super
computer, the concepts here should be generally applicable to typical HPC systems.
This document assumes that you already have an access to an HPC like Cheyenne,
and are comfortable using the command line. It may be necessary to work with your
system administrators to properly configure these tools for your machine.</p>
<p>You should log into your HPC system now.</p>
<div class="section" id="installing-a-software-environment">
<h2>Installing a software environment<a class="headerlink" href="#installing-a-software-environment" title="Permalink to this headline">¶</a></h2>
<p>After you have logged into your HPC system, download and install Miniconda:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">repo</span><span class="o">.</span><span class="n">continuum</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">miniconda</span><span class="o">/</span><span class="n">Miniconda3</span><span class="o">-</span><span class="n">latest</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">sh</span>
<span class="n">chmod</span> <span class="o">+</span><span class="n">x</span> <span class="n">Miniconda3</span><span class="o">-</span><span class="n">latest</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">sh</span>
<span class="o">./</span><span class="n">Miniconda3</span><span class="o">-</span><span class="n">latest</span><span class="o">-</span><span class="n">Linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>This contains a self-contained Python environment that we can manipulate
safely without requiring the involvement of IT. It also allows you to
create isolated software environments so that we can experiment in the
future safely.</p>
<p>Create a new conda environment for our pangeo work:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">conda</span> <span class="n">create</span> <span class="o">-</span><span class="n">n</span> <span class="n">pangeo</span> <span class="o">-</span><span class="n">c</span> <span class="n">conda</span><span class="o">-</span><span class="n">forge</span> \
    <span class="n">python</span><span class="o">=</span><span class="mf">3.6</span> <span class="n">dask</span> <span class="n">distributed</span> <span class="n">xarray</span> <span class="n">jupyterlab</span> <span class="n">mpi4py</span> <span class="n">dask_jobqueue</span>
</pre></div>
</div>
<p>Activate this environment</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">activate</span> <span class="n">pangeo</span>
</pre></div>
</div>
<p>Your prompt should now look something like this (note the pangeo environment name):</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(pangeo) $
</pre></div>
</div>
<p>And if you ask where your Python command lives, it should direct you to
somewhere in your home directory:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(pangeo) $ which python
/home/username/miniconda3/envs/pangeo/bin/python
</pre></div>
</div>
</div>
<div class="section" id="configure-jupyter">
<h2>Configure Jupyter<a class="headerlink" href="#configure-jupyter" title="Permalink to this headline">¶</a></h2>
<p>(If you don’t plan to use Jupyter notebooks then you can safely skip
this section.)</p>
<p>Jupyter notebook servers include a password for security. We’re going to
setup a password for ourselves. First we generate the Jupyter config
file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">notebook</span> <span class="o">--</span><span class="n">generate</span><span class="o">-</span><span class="n">config</span>
</pre></div>
</div>
<p>This created a file in <code class="docutils literal"><span class="pre">~/.jupyter/jupyter_notebook_config.py</span></code>. If you
open that file and search for “password”, you’ll see a line like the
following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="c1">#c.NotebookApp.password = u&#39;&#39;</span>
</pre></div>
</div>
<p>The instructions in the comments of the config file tell you to generate
a hashed password by entering the following commands:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ipython
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">from</span> <span class="nn">notebook.auth</span> <span class="kn">import</span> <span class="n">passwd</span><span class="p">;</span> <span class="n">passwd</span><span class="p">()</span>
<span class="n">Enter</span> <span class="n">password</span><span class="p">:</span>
</pre></div>
</div>
<p>You can enter a password of your choice, and it will return to you a
encoded password. I entered “password” (do not do this) and go the following
output:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="s1">&#39;sha1:69a76df803b9:99ca27341563cd85ba4e78684128e1f4ad2d8d0d&#39;</span>
</pre></div>
</div>
<p>Copy that string into your <code class="docutils literal"><span class="pre">jupyter_notebook_config.py</span></code> config file</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">NotebookApp</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="sa">u</span><span class="s1">&#39;sha1:69a76df803b9:99ca27341563cd85ba4e78684128e1f4ad2d8d0d&#39;</span>
</pre></div>
</div>
<p>For security reasons, we recommend making sure your <code class="docutils literal"><span class="pre">jupyter_notebook_config.py</span></code>
is readable only by you. For more information on and other methods for
securing Jupyter, check out
<a class="reference external" href="http://jupyter-notebook.readthedocs.io/en/stable/public_server.html#securing-a-notebook-server">Securing a notebook server</a>
in the Jupyter documentation.</p>
<hr class="docutils" />
<p>From here, we have two options. Option 1 will start a Jupyter Notebook server
and manage dask using the <a class="reference external" href="http://dask-jobqueue.readthedocs.io">dask-jobqueue</a> package. Option 2 will start a dask
cluster using <cite>dask-mpi</cite> and will run a Jupyter server as part of the dask cluster.
We generally recommend starting with Option 1, espcially if you will be working
interactively, unless you have a reason for managing the job submission scripts
on your own. Users that will be using dask in batch-style workflows may prefer
Option 2.</p>
</div>
<div class="section" id="deploy-option-1-jupyter-dask-jobqueue">
<h2>Deploy Option 1: Jupyter + dask-jobqueue<a class="headerlink" href="#deploy-option-1-jupyter-dask-jobqueue" title="Permalink to this headline">¶</a></h2>
<div class="section" id="start-a-jupyter-notebook-server">
<h3>Start a Jupyter Notebook Server<a class="headerlink" href="#start-a-jupyter-notebook-server" title="Permalink to this headline">¶</a></h3>
<p>Now that we have Jupyter configured, we can start a notebook server. In many
cases, your system administrators will want you to run this notebook server in
an interactive session on a compute node. This is not universal rule, but it is
one we’ll follow for this tutorial.</p>
<p>In our case, the Cheyenne super computer uses the PBS job scheduler, so typing:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(pangeo) $ qsub -I -l select=1:ncpus=4 -l walltime=03:00:00 -q regular
</pre></div>
</div>
<p>This will get us an interactive job on the <cite>regular</cite> queue for three hours. You
may not see the <cite>pangeo</cite> environment anymore in your prompt, in this case, you
will want to reactivate it.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">source</span> <span class="n">activate</span> <span class="n">pangeo</span>
</pre></div>
</div>
<p>From here, we can start jupyter. The Cheyenne computer administrators have
developed a <a class="reference external" href="https://www2.cisl.ucar.edu/resources/computational-systems/cheyenne/software/jupyter-and-ipython#notebook">start-notebook</a>
utility that wraps the following steps into a single execution. You should
check with your system administrators to see if they have something similar.
If not, you’ll need to take the following steps:</p>
<p>Copy this line into your terminal. It will echo a command you’ll want to use
later.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(pangeo) $ echo &quot;ssh -N -L 8877:`hostname`:8877 -L 8878:`hostname`:8878 $USER@cheyenne.ucar.edu&quot;
ssh -N -L 8877:r8i4n0:8877 -L 8878:r8i4n0:8878 username@cheyenne.ucar.edu
</pre></div>
</div>
<p>Now we can launch the notebook server:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>(pangeo) $ jupyter lab --no-browser --ip=`hostname` --port=8877
...
[I 13:36:52.321 LabApp] The Jupyter Notebook is running at:
[I 13:36:52.321 LabApp] http://r8i4n0:8877/
[I 13:36:52.321 LabApp] Use Control-C to stop this server and shut down all kernels (twice to skip confirmation).
</pre></div>
</div>
<p>Now, connect to the server using an ssh tunnel from your local machine
(this could be your laptop or desktop).</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ssh -N -L 8877:r8i4n0:8877 -L 8878:r8i4n0:8787 username@cheyenne.ucar.edu
</pre></div>
</div>
<p>You’ll want to change the details in the command above but the basic idea is
that we’re passing the ports 8877 and 8878 from the compute node <cite>r8i4n0</cite> to our
local system. Now open <a class="reference external" href="http://localhost:8877">http://localhost:8877</a> on your local machine, you should
find a jupyter server running!</p>
<p><em>Note that we’re also passing the 8878 port through so we can access the dask
dashboard later.</em></p>
</div>
<div class="section" id="launch-dask-with-dask-jobqueue">
<h3>Launch Dask with dask-jobqueue<a class="headerlink" href="#launch-dask-with-dask-jobqueue" title="Permalink to this headline">¶</a></h3>
<p>Most HPC systems use a job-scheduling system to manage job submissions and
executions among many users. The <a class="reference external" href="http://dask-jobqueue.readthedocs.io">dask-jobqueue</a> package is designed to help
dask interface with these job queuing systems. Usage is quite simple and can be
done from within your Jupyter Notebook:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask_jobqueue</span> <span class="kn">import</span> <span class="n">PBSCluster</span>

<span class="n">cluster</span> <span class="o">=</span> <span class="n">PBSCluster</span><span class="p">(</span><span class="n">processes</span><span class="o">=</span><span class="mi">18</span><span class="p">,</span>
                     <span class="n">threads</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">memory</span><span class="o">=</span><span class="s2">&quot;6GB&quot;</span><span class="p">,</span>
                     <span class="n">project</span><span class="o">=</span><span class="s1">&#39;UCLB0022&#39;</span><span class="p">,</span>
                     <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;premium&#39;</span><span class="p">,</span>
                     <span class="n">resource_spec</span><span class="o">=</span><span class="s1">&#39;select=1:ncpus=36:mem=109G&#39;</span><span class="p">,</span>
                     <span class="n">walltime</span><span class="o">=</span><span class="s1">&#39;02:00:00&#39;</span><span class="p">)</span>
<span class="n">cluster</span><span class="o">.</span><span class="n">start_workers</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">cluster</span><span class="p">)</span>
</pre></div>
</div>
<p>For more examples of how to use <a class="reference external" href="http://dask-jobqueue.readthedocs.io">dask-jobqueue</a>, refer to the <a class="reference external" href="http://dask-jobqueue.readthedocs.io">package documentation</a>.</p>
</div>
</div>
<div class="section" id="deploy-option-2-jupyter-dask-mpi">
<h2>Deploy Option 2: Jupyter + dask-mpi<a class="headerlink" href="#deploy-option-2-jupyter-dask-mpi" title="Permalink to this headline">¶</a></h2>
<p>This approach allows you to deploy dask directly using batch jobs on your HPC
machine.</p>
<p>The MPI library is only used to distribute the dask-workers across the
cluster. MPI is <strong>NOT</strong> used for communication by dask.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>The following scripts and proceedures have been packed into a convenient wrapper
script <code class="docutils literal"><span class="pre">launch-dask.sh</span></code>. It and its supporting utilities can be found in the
<a class="reference external" href="https://github.com/pangeo-data/pangeo/tree/master/utilities/cheyenne">pangeo Github reposository</a>.</p>
<p>The usage of this script is quite simple:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>./launch-dask.sh <span class="si">${</span><span class="nv">N_WORK_NODES</span><span class="si">}</span>
</pre></div>
</div>
<p>where <code class="docutils literal"><span class="pre">N_WORK_NODES</span></code> is the number of nodes you want to add to the cluster
beyond the one that is automatically added for the scheduler. Once this command
has been run, and after a moment for the jobs to work their way through the queue,
it will print something like:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>Run the following <span class="nb">command</span> from your <span class="nb">local</span> machine:
ssh -N -L <span class="m">8877</span>:r7i3n13:8877 -L <span class="m">8878</span>:r7i3n13:8787 username@cheyenne.ucar.edu
Then open the following URLs:
    Jupyter lab: http://localhost:8877
    Dask dashboard: http://localhost:8878
</pre></div>
</div>
<p class="last">It may be ncessessary to modify the included scripts to use different PBS
project number, conda environment, or notebook directory.</p>
</div>
<p><em>The remainder of this section is left here for completeness but for most users,
the ``launch-dask.sh`` script should be enough to get started.</em></p>
<hr class="docutils" />
<p>Copy and paste the following text into a file, dask.sh:</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span><span class="ch">#!/bin/bash</span>
<span class="c1">#PBS -N sample</span>
<span class="c1">#PBS -q economy</span>
<span class="c1">#PBS -A UCLB0022</span>
<span class="c1">#PBS -l select=2:ncpus=36:mpiprocs=6</span>
<span class="c1">#PBS -l walltime=01:00:00</span>
<span class="c1">#PBS -j oe</span>
<span class="c1">#PBS -m abe</span>

<span class="c1"># Qsub template for UCAR CHEYENNE</span>
<span class="c1"># Scheduler: PBS</span>

<span class="c1"># This writes a scheduler.json file into your home directory</span>
<span class="c1"># You can then connect with the following Python code</span>
<span class="c1"># &gt;&gt;&gt; from dask.distributed import Client</span>
<span class="c1"># &gt;&gt;&gt; client = Client(scheduler_file=&#39;~/scheduler.json&#39;)</span>

rm -f scheduler.json
mpirun --np <span class="m">12</span> dask-mpi <span class="se">\</span>
    --nthreads <span class="m">6</span> <span class="se">\</span>
    --memory-limit 24e9 <span class="se">\</span>
    --interface ib0
</pre></div>
</div>
<p>This script asks for two nodes with 36 cores each. It breaks up each
node into 6 MPI processes, each of which gets 6 cores and 24GB of RAM
each. You can tweak the numbers above if you like, but you’ll have to
match some constraints in the PBS directives on the top and the
<code class="docutils literal"><span class="pre">mpirun</span></code> keywords on the bottom.</p>
<p>Submit this script to run on the cluster with <code class="docutils literal"><span class="pre">qsub</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">dask</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>And track its progress with <code class="docutils literal"><span class="pre">qstat</span></code></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ qstat -u $USER

chadmin1:
                                                            Req&#39;d  Req&#39;d   Elap
Job ID          Username Queue    Jobname    SessID NDS TSK Memory Time  S Time
--------------- -------- -------- ---------- ------ --- --- ------ ----- - -----
1681778.chadmin username regular  sample      27872   2 144    --  00:20 R 00:01
</pre></div>
</div>
<p>When this job runs it places a <code class="docutils literal"><span class="pre">scheduler.json</span></code> file in your home
directory. This contains the necessary information to connect to this
cluster from anywhere in the network. We’ll do that now briefly from the
login node. In the next section we’ll set up a Jupyter notebook server
on your allocation.</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ ipython
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="s1">&#39;scheduler.json&#39;</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">Client</span><span class="p">:</span> <span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;tcp://10.148.0.92:8786&#39;</span> <span class="n">processes</span><span class="o">=</span><span class="mi">11</span> <span class="n">cores</span><span class="o">=</span><span class="mi">66</span><span class="o">&gt;</span>
</pre></div>
</div>
<div class="section" id="launch-and-connect-to-jupyter">
<h3>Launch and connect to Jupyter<a class="headerlink" href="#launch-and-connect-to-jupyter" title="Permalink to this headline">¶</a></h3>
<p>From your same session on the login node, run the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="kn">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="s1">&#39;scheduler.json&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">socket</span>
<span class="n">host</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">run_on_scheduler</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">gethostname</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">start_jlab</span><span class="p">(</span><span class="n">dask_scheduler</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">subprocess</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;jupyter&#39;</span><span class="p">,</span> <span class="s1">&#39;lab&#39;</span><span class="p">,</span> <span class="s1">&#39;--ip&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="s1">&#39;--no-browser&#39;</span><span class="p">])</span>
    <span class="n">dask_scheduler</span><span class="o">.</span><span class="n">jlab_proc</span> <span class="o">=</span> <span class="n">proc</span>

<span class="n">client</span><span class="o">.</span><span class="n">run_on_scheduler</span><span class="p">(</span><span class="n">start_jlab</span><span class="p">)</span>

<span class="k">print</span><span class="p">(</span><span class="s2">&quot;ssh -N -L 8787:</span><span class="si">%s</span><span class="s2">:8787 -L 8888:</span><span class="si">%s</span><span class="s2">:8888 cheyenne.ucar.edu&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">host</span><span class="p">))</span>
</pre></div>
</div>
<p>This should print out a statement like the following:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">N</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8787</span><span class="p">:</span><span class="n">r13i2n1</span><span class="p">:</span><span class="mi">8787</span> <span class="o">-</span><span class="n">L</span> <span class="mi">8888</span><span class="p">:</span><span class="n">r13i2n1</span><span class="p">:</span><span class="mi">8888</span> <span class="o">-</span><span class="n">l</span> <span class="n">username</span> <span class="n">cheyenne</span><span class="o">.</span><span class="n">ucar</span><span class="o">.</span><span class="n">edu</span>
</pre></div>
</div>
<p>You can run this command from your personal computer (not the terminal
logged into Cheyenne) to set up SSH-tunnels that will allow you to log
into web servers running on your allocation. Afterwards, you should be
able to open the following links in your web browser on your computer:</p>
<ul class="simple">
<li>Jupyter Lab: <a class="reference external" href="http://localhost:8888">http://localhost:8888</a></li>
<li>Dask dashboard: <a class="reference external" href="http://localhost:8787/status">http://localhost:8787/status</a></li>
</ul>
<p>The SSH tunnels will route these into the correct machine in your
cluster allocation.</p>
<p><strong>Dynamic Deployment</strong></p>
<p>The job scheduler that manages the cluster is not intended for
interactive work like what we do with Jupyter notebooks. When we ask for
a modestly large deployment (like five machines) it may wait for hours
to find an appropriate time slot to deploy our job. This can be
inconvenient because our human schedules may not match up well with the
cluster’s job scheduler.</p>
<p>However we seem to be able to get much faster response from the job
scheduler if we launch many single-machine jobs. This allows us to get
larger allocations faster (often immediately).</p>
<p>We can do this by making our deployment process a little bit more
complex by splitting it into two jobs:</p>
<ol class="arabic simple">
<li>One job that launches a scheduler and a few workers on one machine</li>
<li>Another job that only launches workers on one machine</li>
</ol>
<p>Write these two scripts to your home directory:</p>
<p><strong>Main script</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
#PBS -N dask
#PBS -q economy
#PBS -A UCLB0022
#PBS -l select=1:ncpus=36:mpiprocs=6
#PBS -l walltime=00:30:00
#PBS -j oe
#PBS -m abe

# Writes ~/scheduler.json file in home directory
# Connect with
# &gt;&gt;&gt; from dask.distributed import Client
# &gt;&gt;&gt; client = Client(scheduler_file=&#39;~/scheduler.json&#39;)

rm -f scheduler.json
mpirun --np 6 dask-mpi --nthreads 6 \
    --memory-limit 22e9 \
    --interface ib0 \
    --local-directory $TMPDIR
</pre></div>
</div>
<p><strong>Add one worker script</strong></p>
<div class="highlight-default"><div class="highlight"><pre><span></span>#!/bin/bash
#PBS -N dask-workers
#PBS -q economy
#PBS -A UCLB0022
#PBS -l select=1:ncpus=36:mpiprocs=6
#PBS -l walltime=00:30:00
#PBS -j oe
#PBS -m abe

mpirun --np 6 dask-mpi --nthreads 6 \
    --memory-limit 22e9 \
    --interface ib0 \
    --no-scheduler \
    --local-directory $TMPDIR
</pre></div>
</div>
<p>And then run the main one once</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">main</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>And the second one a few times</p>
<div class="highlight-default"><div class="highlight"><pre><span></span><span class="n">qsub</span> <span class="n">add</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">worker</span><span class="o">.</span><span class="n">sh</span>
<span class="n">qsub</span> <span class="n">add</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">worker</span><span class="o">.</span><span class="n">sh</span>
<span class="n">qsub</span> <span class="n">add</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">worker</span><span class="o">.</span><span class="n">sh</span>
<span class="n">qsub</span> <span class="n">add</span><span class="o">-</span><span class="n">one</span><span class="o">-</span><span class="n">worker</span><span class="o">.</span><span class="n">sh</span>
</pre></div>
</div>
<p>You can run this more times during your session to increase your
allocation dynamically. You can also kill these jobs independently to
contract your allocation dynamically and save compute time.</p>
</div>
</div>
<div class="section" id="further-reading">
<h2>Further Reading<a class="headerlink" href="#further-reading" title="Permalink to this headline">¶</a></h2>
<p>We have not attempted to provide a comprehensive tutorial on how to use Pangeo,
Dask, or Jupyter on HPC systems. This is because each HPC system is uniquely
configured. Instead we have provided two generalizable workflows for deploying
Pangeo. Below we provide a few useful links that will be useful for further
customization of these tools.</p>
<blockquote>
<div><ul class="simple">
<li><a class="reference external" href="http://dask.pydata.org/en/latest/setup/hpc.html">Deploying Dask on HPC</a></li>
<li><a class="reference external" href="http://jupyter-notebook.readthedocs.io/en/stable/index.html">Configuring and Deploying Jupyter Servers</a></li>
</ul>
</div></blockquote>
</div>
</div>


      
      
    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Pangeo Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>
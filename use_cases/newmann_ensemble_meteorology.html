<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Analysis of Gridded Ensemble Precipitation and Temperature Estimates over the Contiguous United States &#8212; Pangeo 0.0.1 documentation</title>
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Use Case: CM2.6 Eddy Statistics" href="ocean_cm2.6_eddy_statistics.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  </head>
  <body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          Pangeo</a>
        <span class="navbar-text navbar-version pull-left"><b>0.0.1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="http://pangeo-data.github.io">Blog</a></li>
            
            
              <li class="dropdown globaltoc-container">
  <a role="button"
     id="dLabelGlobalToc"
     data-toggle="dropdown"
     data-target="#"
     href="../index.html">Site <b class="caret"></b></a>
  <ul class="dropdown-menu globaltoc"
      role="menu"
      aria-labelledby="dLabelGlobalToc"><p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../about.html">About Pangeo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../setup_guides/index.html">Pangeo Setup Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../setup_guides/cheyenne.html">Getting Started with Dask on Cheyenne</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Pangeo Use Cases</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="ocean_cm2.6_eddy_statistics.html">Use Case: CM2.6 Eddy Statistics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Analysis of Gridded Ensemble Precipitation and Temperature Estimates over the Contiguous United States</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
                <li class="dropdown">
  <a role="button"
     id="dLabelLocalToc"
     data-toggle="dropdown"
     data-target="#"
     href="#">Page <b class="caret"></b></a>
  <ul class="dropdown-menu localtoc"
      role="menu"
      aria-labelledby="dLabelLocalToc"><ul>
<li><a class="reference internal" href="#">Analysis of Gridded Ensemble Precipitation and Temperature Estimates over the Contiguous United States</a><ul>
<li><a class="reference internal" href="#Connect-to-Dask-Distributed-Cluster">Connect to Dask Distributed Cluster</a></li>
<li><a class="reference internal" href="#Open-the-dataset-using-Xarray">Open the dataset using Xarray</a><ul>
<li><a class="reference internal" href="#Metadata">Metadata</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Figure:-Domain-mask">Figure: Domain mask</a></li>
<li><a class="reference internal" href="#Look!-All-these-arrays-are-dask-arrays-under-the-hood.-Note-the-chunk-sizes">Look! All these arrays are dask arrays under the hood. Note the chunk sizes</a></li>
<li><a class="reference internal" href="#Intra-ensemble-range">Intra-ensemble range</a></li>
<li><a class="reference internal" href="#Calling-compute">Calling compute</a><ul>
<li><a class="reference internal" href="#Figure:-Intra-ensemble-range">Figure: Intra-ensemble range</a></li>
</ul>
</li>
<li><a class="reference internal" href="#Persisting-data-on-the-cluster">Persisting data on the cluster</a></li>
</ul>
</li>
</ul>
</ul>
</li>
              
            
            
              
                
  <li>
    <a href="ocean_cm2.6_eddy_statistics.html" title="Previous Chapter: Use Case: CM2.6 Eddy Statistics"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Use Case: CM2...</span>
    </a>
  </li>
              
            
            
            
            
              <li class="hidden-sm">
<div id="sourcelink">
  <a href="../_sources/use_cases/newmann_ensemble_meteorology.ipynb.txt"
     rel="nofollow">Source</a>
</div></li>
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    <div class="col-md-12 content">
      
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput,
div.nbinput div.prompt,
div.nbinput div.input_area,
div.nbinput div[class*=highlight],
div.nbinput div[class*=highlight] pre,
div.nboutput,
div.nbinput div.prompt,
div.nbinput div.output_area,
div.nboutput div[class*=highlight],
div.nboutput div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput,
div.nboutput {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput,
    div.nboutput {
        flex-direction: column;
    }
}

/* input container */
div.nbinput {
    padding-top: 5px;
}

/* last container */
div.nblast {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput div.prompt pre {
    color: #303F9F;
}

/* output prompt */
div.nboutput div.prompt pre {
    color: #D84315;
}

/* all prompts */
div.nbinput div.prompt,
div.nboutput div.prompt {
    min-width: 9ex;
    padding-top: 0.4em;
    padding-right: 0.4em;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput div.prompt,
    div.nboutput div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput div.prompt pre,
div.nboutput div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput div.input_area,
div.nboutput div.output_area {
    padding: 0.4em;
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput div.input_area,
    div.nboutput div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput div.input_area {
    border: 1px solid #cfcfcf;
    border-radius: 2px;
    background: #f7f7f7;
}

/* override MathJax center alignment in output cells */
div.nboutput div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.pngmath center alignment in output cells */
div.nboutput div.math p {
    text-align: left;
}

/* standard error */
div.nboutput div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }
</style>
<div class="section" id="Analysis-of-Gridded-Ensemble-Precipitation-and-Temperature-Estimates-over-the-Contiguous-United-States">
<h1>Analysis of Gridded Ensemble Precipitation and Temperature Estimates over the Contiguous United States<a class="headerlink" href="#Analysis-of-Gridded-Ensemble-Precipitation-and-Temperature-Estimates-over-the-Contiguous-United-States" title="Permalink to this headline">¶</a></h1>
<p>by <a class="reference external" href="https://github.com/jhamman/">Joe Hamman</a> and <a class="reference external" href="https://github.com/mrocklin/">Matthew
Rocklin</a></p>
<p>For this example, we’ll open a 100 member ensemble of precipitation and
temperature data. Each ensemble member is stored in a seperate netCDF
file and are otherwise formatted identically. The analysis we do below
is quite simple but the problem is a good illustration of an IO bound
task.</p>
<p>Link to dataset:
<a class="reference external" href="https://www.earthsystemgrid.org/dataset/gridded_precip_and_temp.html">https://www.earthsystemgrid.org/dataset/gridded_precip_and_temp.html</a></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre></div>
</div>
</div>
<div class="section" id="Connect-to-Dask-Distributed-Cluster">
<h2>Connect to Dask Distributed Cluster<a class="headerlink" href="#Connect-to-Dask-Distributed-Cluster" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">dask.distributed</span> <span class="k">import</span> <span class="n">Client</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">Client</span><span class="p">(</span><span class="n">scheduler_file</span><span class="o">=</span><span class="s1">&#39;/glade/scratch/jhamman/scheduler.json&#39;</span><span class="p">)</span>
<span class="n">client</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[2]:
</pre></div>
</div>
<div class="output_area docutils container">
<table style="border: 2px solid white;">
<tr>
<td style="vertical-align: top; border: 0px solid white">
<h3>Client</h3>
<ul>
  <li><b>Scheduler: </b>tcp://10.148.5.204:8786
  <li><b>Dashboard: </b><a href='http://10.148.5.204:8787' target='_blank'>http://10.148.5.204:8787</a>
</ul>
</td>
<td style="vertical-align: top; border: 0px solid white">
<h3>Cluster</h3>
<ul>
  <li><b>Workers: </b>65</li>
  <li><b>Cores: </b>390</li>
  <li><b>Memory: </b>1430.00 GB</li>
</ul>
</td>
</tr>
</table></div>
</div>
</div>
<div class="section" id="Open-the-dataset-using-Xarray">
<h2>Open the dataset using Xarray<a class="headerlink" href="#Open-the-dataset-using-Xarray" title="Permalink to this headline">¶</a></h2>
<p>Here we open the 100 member ensemble. Each ensemble member is stored as
a single file and we use <code class="docutils literal"><span class="pre">xarray.open_mfdataset</span></code> to concatenate them
along a new <code class="docutils literal"><span class="pre">ensemble</span></code> dimension. In addition to chunking along the
<code class="docutils literal"><span class="pre">ensemble</span></code> dimension (defaults to 1 chunk per file), we’ll also chunk
along the <code class="docutils literal"><span class="pre">time</span></code> dimension.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ds</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_mfdataset</span><span class="p">(</span><span class="s1">&#39;/glade/u/home/jhamman/workdir/GARD_inputs/newman_ensemble/conus_ens_[01]*&#39;</span><span class="p">,</span>
                       <span class="n">engine</span><span class="o">=</span><span class="s1">&#39;netcdf4&#39;</span><span class="p">,</span> <span class="n">concat_dim</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="p">,</span> <span class="n">chunks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="mi">366</span><span class="p">})</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># These clean up tasks can be removed after xarray 0.10 is release</span>
<span class="n">ds</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;elevation&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ensemble</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ensemble</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">)</span>
<span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="Metadata">
<h3>Metadata<a class="headerlink" href="#Metadata" title="Permalink to this headline">¶</a></h3>
<p>Let’s start by printing some metadata before we get started with the fun</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;ds size in GB </span><span class="si">{:0.2f}</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ds</span><span class="o">.</span><span class="n">nbytes</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">))</span>

<span class="n">ds</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ds size in GB 5011.38

xarray.Dataset {
dimensions:
        ensemble = 100 ;
        lat = 224 ;
        lon = 464 ;
        time = 12054 ;

variables:
        datetime64[ns] time(time) ;
                time:standard_name = time ;
        float64 lon(lon) ;
                lon:long_name = longitude ;
                lon:units = degrees_east ;
                lon:standard_name = latitude ;
        float64 lat(lat) ;
                lat:long_name = latitude ;
                lat:units = degrees_north ;
                lat:standard_name = latitude ;
        float64 elevation(lat, lon) ;
                elevation:units = meters ;
                elevation:long_name = Terrain Elevation ;
                elevation:standard_name = elevation ;
        float64 pcp(ensemble, time, lat, lon) ;
                pcp:long_name = Daily estimated precipitation accumulation ;
                pcp:units = kg m-2 ;
                pcp:standard_name = precipitation ;
        float64 t_mean(ensemble, time, lat, lon) ;
                t_mean:long_name = Daily estimated mean temperature ;
                t_mean:units = degC ;
        float64 t_range(ensemble, time, lat, lon) ;
                t_range:long_name = Daily estimated diurnal temperature range ;
                t_range:units = degC ;
        float64 mask(lat, lon) ;
        float64 t_max(ensemble, time, lat, lon) ;
                t_max:long_name = Daily estimated maximum temperature ;
                t_max:units = degC ;
        float64 t_min(ensemble, time, lat, lon) ;
                t_min:long_name = Daily estimated maximum temperature ;
                t_min:units = degC ;

// global attributes:
        :history = Version 1.0 of ensemble dataset, created December 2014.Fri Sep 08 12:25:30 2017jhamman: corrected mask and added t_min and tmax as ds[&#39;t_mean&#39;] +/- 0.5 * ds[&#39;t_range&#39;]
 ;
        :nco_openmp_thread_number = 1 ;
        :institution = National Center for Atmospheric Research (NCAR), Boulder, CO USA ;
        :title = CONUS daily 12-km gridded ensemble precipitation and temperature dataset for 1980-2012 ;
        :source = Generated using version 1.0 of CONUS ensemble code base ;
        :references = Newman et al. 2015: Gridded Ensemble Precipitation and Temperature Estimates for the Contiguous United States. J. Hydrometeorology ;
}
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Figure:-Domain-mask">
<h2>Figure: Domain mask<a class="headerlink" href="#Figure:-Domain-mask" title="Permalink to this headline">¶</a></h2>
<p>A quick plot of the mask to give us an idea of the spatial domain we’re
working with</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">ds</span><span class="p">[</span><span class="s1">&#39;mask&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;mask&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[6]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x2aaae62a5198&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/use_cases_newmann_ensemble_meteorology_10_1.png" src="../_images/use_cases_newmann_ensemble_meteorology_10_1.png" />
</div>
</div>
</div>
<div class="section" id="Look!-All-these-arrays-are-dask-arrays-under-the-hood.-Note-the-chunk-sizes">
<h2>Look! All these arrays are dask arrays under the hood. Note the chunk sizes<a class="headerlink" href="#Look!-All-these-arrays-are-dask-arrays-under-the-hood.-Note-the-chunk-sizes" title="Permalink to this headline">¶</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">da</span> <span class="ow">in</span> <span class="n">ds</span><span class="o">.</span><span class="n">data_vars</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">da</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
elevation dask.array&lt;getitem, shape=(224, 464), dtype=float64, chunksize=(224, 464)&gt;
pcp dask.array&lt;concatenate, shape=(100, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
t_mean dask.array&lt;concatenate, shape=(100, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
t_range dask.array&lt;concatenate, shape=(100, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
mask dask.array&lt;where, shape=(224, 464), dtype=float64, chunksize=(224, 464)&gt;
t_max dask.array&lt;concatenate, shape=(100, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
t_min dask.array&lt;concatenate, shape=(100, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
</pre></div></div>
</div>
</div>
<div class="section" id="Intra-ensemble-range">
<h2>Intra-ensemble range<a class="headerlink" href="#Intra-ensemble-range" title="Permalink to this headline">¶</a></h2>
<p>We can start by calculating the intra-ensemble range for all the mean
daily temperature in this dataset.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="c1"># calculates the long term mean along the time dimension</span>
<span class="n">da_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;t_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;time&#39;</span><span class="p">)</span>
<span class="c1"># calculate the intra-ensemble range of long term means</span>
<span class="n">da_spread</span> <span class="o">=</span> <span class="n">da_mean</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">da_mean</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s1">&#39;ensemble&#39;</span><span class="p">)</span>
<span class="n">da_spread</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[8]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;xarray.DataArray &#39;t_mean&#39; (lat: 224, lon: 464)&gt;
dask.array&lt;sub, shape=(224, 464), dtype=float64, chunksize=(224, 464)&gt;
Coordinates:
  * lon      (lon) float64 -124.9 -124.8 -124.7 -124.6 -124.4 -124.3 -124.2 ...
  * lat      (lat) float64 25.06 25.19 25.31 25.44 25.56 25.69 25.81 25.94 ...
</pre></div>
</div>
</div>
</div>
<div class="section" id="Calling-compute">
<h2>Calling compute<a class="headerlink" href="#Calling-compute" title="Permalink to this headline">¶</a></h2>
<p>The expressions above didn’t actually compute anything. They just build
the dask task graph. To do the computations, we call the <code class="docutils literal"><span class="pre">compute</span></code>
method:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">time</span> da_spread = da_spread.compute()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 1.77 s, sys: 40 ms, total: 1.81 s
Wall time: 4min 19s
</pre></div></div>
</div>
<div class="section" id="Figure:-Intra-ensemble-range">
<h3>Figure: Intra-ensemble range<a class="headerlink" href="#Figure:-Intra-ensemble-range" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">da_spread</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intra-ensemble range in mean annual temperature&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[10]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x2aaae613e470&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/use_cases_newmann_ensemble_meteorology_18_1.png" src="../_images/use_cases_newmann_ensemble_meteorology_18_1.png" />
</div>
</div>
</div>
</div>
<div class="section" id="Persisting-data-on-the-cluster">
<h2>Persisting data on the cluster<a class="headerlink" href="#Persisting-data-on-the-cluster" title="Permalink to this headline">¶</a></h2>
<p>(Make sure you have well over 300GB of RAM on your cluster, you can
change the <code class="docutils literal"><span class="pre">ensemble=slice(0,</span> <span class="pre">25)</span></code> section below to use more/less
ensemble members.</p>
<p>Most of the time spent in the last calculation was loading data from
disk. After we were done with this data, Dask threw it away to free up
memory. If we plan to reuse the same dataset many times then we may want
to <code class="docutils literal"><span class="pre">persist</span></code> it in memory.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">t_mean</span> <span class="o">=</span> <span class="n">ds</span><span class="p">[</span><span class="s1">&#39;t_mean&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">ensemble</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">25</span><span class="p">))</span>
<span class="n">t_mean</span> <span class="o">=</span> <span class="n">t_mean</span><span class="o">.</span><span class="n">persist</span><span class="p">()</span>
<span class="n">t_mean</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[11]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;xarray.DataArray &#39;t_mean&#39; (ensemble: 25, time: 12054, lat: 224, lon: 464)&gt;
dask.array&lt;getitem, shape=(25, 12054, 224, 464), dtype=float64, chunksize=(1, 366, 224, 464)&gt;
Coordinates:
  * time     (time) datetime64[ns] 1980-01-01 1980-01-02 1980-01-03 ...
  * lon      (lon) float64 -124.9 -124.8 -124.7 -124.6 -124.4 -124.3 -124.2 ...
  * lat      (lat) float64 25.06 25.19 25.31 25.44 25.56 25.69 25.81 25.94 ...
Dimensions without coordinates: ensemble
Attributes:
    long_name:  Daily estimated mean temperature
    units:      degC
</pre></div>
</div>
</div>
<p>Now the t_mean DataArray is resident in memory on our workers. We can
repeat our computation from last time much more quickly.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">time</span>
temp_mean = t_mean.mean(dim=&#39;time&#39;)
spread = temp_mean.max(dim=&#39;ensemble&#39;) - temp_mean.min(dim=&#39;ensemble&#39;)  # calculates the intra-ensemble range of long term means
mean = spread.compute()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 588 ms, sys: 32 ms, total: 620 ms
Wall time: 1min 17s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">mean</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intra-ensemble range in mean annual temperature&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[13]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x2aaae652eb70&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/use_cases_newmann_ensemble_meteorology_23_1.png" src="../_images/use_cases_newmann_ensemble_meteorology_23_1.png" />
</div>
</div>
<p>And we can also modify the computation and try something new. Keeping
data in memory allows to <em>iterate quickly</em>, which is the whole point of
this exercise.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="o">%%</span><span class="k">time</span>
temp_mean = t_mean.std(dim=&#39;time&#39;)
spread = temp_mean.max(dim=&#39;ensemble&#39;) - temp_mean.min(dim=&#39;ensemble&#39;)  # calculates the intra-ensemble range of long term means
std = spread.compute()
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
CPU times: user 428 ms, sys: 8 ms, total: 436 ms
Wall time: 9 s
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>In [15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3"><div class="highlight"><pre>
<span></span><span class="n">std</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">robust</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Intra-ensemble range in standard deviation of annual temperature&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none"><div class="highlight"><pre>
<span></span>Out[15]:
</pre></div>
</div>
<div class="output_area highlight-none"><div class="highlight"><pre>
<span></span>&lt;matplotlib.text.Text at 0x2aaae668a668&gt;
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/use_cases_newmann_ensemble_meteorology_26_1.png" src="../_images/use_cases_newmann_ensemble_meteorology_26_1.png" />
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2017, Pangeo Team.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.5.<br/>
    </p>
  </div>
</footer>
  </body>
</html>